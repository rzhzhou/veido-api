"use strict";!function(){if("function"!=typeof $.fn.twbsPagination)throw new Error("twbsPagination required");var n={first:"第一页",prev:"上一页",next:"下一页",last:"最后一页",paginationClass:"pagination pagination-sm no-margin pull-right"};$.extend($.fn.twbsPagination.defaults,n)}(),function(){if("function"!=typeof moment)throw new Error("moment required");moment.defaultFormat="YYYY-MM-DD"}();
"use strict";!function(n){n.fn.showRisk=function(){var s=this.find("td.risk-score"),a=this.find("td.local-relevance"),i=function(s){return function(a,i){var t=n(i).data("num"),e=n(i).find("i");e.slice(0,t).removeClass(s+"-o").addClass(s)}};return s.each(i("fa-star")),a.each(i("fa-square")),this}}(jQuery);
"use strict";var App={module:{},page:{}};App.module.login=function(){var e=document.forms.login,t=e.action,a=e.elements,n=a.username,i=a.password,o=a[2],s=$(e).find("p"),r=function(){o.disabled=!(n.value&&i.value)},l=function(a){a.preventDefault(),$.post(t,$(e).serialize(),function(e){e.status?location.href=location.search?location.search.substr(1).split("=")[1]:"/":(s.text("用户名或密码错误！"),o.disabled=!0,i.value="")})};$(e).keyup(r).submit(l)},App.module.register=function(){var e=document.forms.add,t=e.action,a=e.elements,n=a.username,i=a.password,o=a.retype,s=a[3],r=$(e).find("p"),l=function(){s.disabled=!(n.value&&i.value&&o.value)},c=function(e){e.preventDefault();var a=function(e){e.status?location.reload():r.text("抱歉，添加失败！").show()};i.value===o.value?$.post(t,$([n,i]).serialize(),a):(r.text("两次输入密码不一致！").show(),s.disabled=!0,i.value="",o.value="")};$(e).keyup(l).submit(c)},App.module.admin=function(){var e=$(".user-admin"),t=e.find("input"),a=e.find("button"),n=a.eq(0),i=a.eq(1),o=[],s=function(e,a){e.click(function(){o.length=0,t.filter(":checked").each(function(e,t){o.push($(t).parent().next().data("id"))}),o.length&&$.post(a,{id:o.toString()},function(e){e.status&&location.reload()})})};s(n,"/api/user/reset/"),s(i,"/api/user/remove/")},App.module.settings=function(){var e=document.forms.info,t=e.action,a=e.elements,n=a.username,i=a.oldPassword,o=a.newPassword,s=a.retype,r=a[4],l=$(e).find("p"),c=function(){r.disabled=!(n.value&&i.value&&o.value&&s.value)},u=function(e){e.preventDefault();var a=function(e){e.status?(l.text("更新成功！").show(),location.href="/login/"):(l.text("原密码错误！").show(),i.value="",o.value="",s.value="")};o.value===s.value?$.post(t,$([n,i,o]).serialize(),a):(l.text("两次输入密码不一致！").show(),o.value="",s.value="")};$(e).keyup(c).submit(u)},App.module.line=function(e){$.getJSON("/api/line"+e,function(e){echarts.init($("#line-chart")[0],"macarons").setOption({color:["#00a65a","#00c0ef","#dd4b39"],tooltip:{trigger:"axis"},legend:{data:["正面","中性","负面"]},grid:{x:40,y:30,x2:25,y2:30},xAxis:[{type:"category",boundaryGap:!1,data:e.date}],yAxis:[{type:"value"}],series:[{name:"正面",type:"line",data:e.positive},{name:"中性",type:"line",data:e.neutral},{name:"负面",type:"line",data:e.negative}]})})},App.module.pie=function(e){$.getJSON("/api/pie"+e,function(e){echarts.init($("#pie-chart")[0],"macarons").setOption({tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{data:e.name},series:[{name:"信息比例",type:"pie",radius:"55%",center:["50%","60%"],data:e.value}]})})},App.module.map=function(){$.getJSON("/api/map/",function(e){var t,a=e.regionData,n=[];for(var i in a)switch(n[i]=a[i].rank,n[i]){case"A":n[i]=1;break;case"B":n[i]=1;break;case"C":n[i]=2;break;case"D":n[i]=3;break;case"E":n[i]=3;break;default:n[i]=3}echarts.util.mapData.params.params.wh={getGeoJson:function(e){$.getJSON("/static/wh.json",e)}},echarts.init(document.getElementById("map-chart")).setOption({title:{subtext:""},tooltip:{trigger:"item",formatter:function(e){for(var i in a)if(e[1]===a[i].regionName)switch(t=n[i]){case 1:t="A";break;case 2:t="B";break;case 3:t="C";break;default:t="erro"}return e[1]+"<br>风险等级  "+t}},legend:{orient:"vertical",x:"right",data:[""]},dataRange:{min:0,max:3,splitNumber:3,color:["#fa9529","#fff26e","#cee19e"],formatter:function(e,t){return"1"===t?"A-低风险":"2"===t?"B-中风险":"3"===t?"C-高风险":void 0},x:"right"},series:[{name:"数据名称",type:"map",mapType:"wh",selectedMode:"single",itemStyle:{normal:{label:{show:!1}},emphasis:{label:{show:!0}}},data:[{name:"江岸区",value:n[4]},{name:"江汉区",value:n[6]},{name:"硚口区",value:n[10]},{name:"汉阳区",value:n[11]},{name:"武昌区",value:n[0]},{name:"洪山区",value:n[1]},{name:"青山区",value:n[3]},{name:"东西湖区",value:n[9]},{name:"蔡甸区",value:n[12]},{name:"江夏区",value:n[2]},{name:"黄陂区",value:n[7]},{name:"新洲区",value:n[8]},{name:"汉南区",value:n[13]}]}]})})},App.module.search=function(){var e=document.forms.search,t=e.elements.keywords;$(e).submit(function(a){a.preventDefault();var n=$.trim(t.value);n&&(e.reset(),location.href="/search/"+n+"/")})},App.module.menu=function(e,t){var a=$(".sidebar-menu"),n=a.parent(),i=function(){var a=this.getAttribute("href");switch(!0){case"dashboard"===t:return"/"===a;case"category"===t:case"location"===t:case"analytics"===t:return a===e;default:return a.split("/")[1]===t}};a.detach().find("a").filter(i).parent().addClass("active").closest(".treeview-menu").addClass("menu-open").closest(".treeview").addClass("active"),a.appendTo(n)},App.module.inspection=function(){var e=$("#inspection"),t=e.children(".box-body").find("tbody");t.load("/api/dashboard/local-inspection/"),e.on("click","button",function(e){return e.preventDefault(),$(this).hasClass("active")?!1:($(this).addClass("active").siblings().removeClass("active"),void t.load("/api/dashboard/"+this.id+"/"))})},App.module.returnTop=function(e){var t=e.offset().top,a=t>160?t-120:0;$("body").animate({scrollTop:a})},App.module.paginate=function(e){var t=this.returnTop.bind(this),a=$(e.container).closest(".box"),n=$(e.container).closest(".box-body"),i=$('<div class="overlay"><i class="fa fa-refresh fa-spin"></i></div>'),o=function(o,s){$.ajax({url:e.api,data:e.filter(s),beforeSend:function(){i.appendTo(a)},success:function(a){e.render(e.container,a.html),i.detach(),t(n)}})};$.ajax({url:e.api,data:e.filter(),beforeSend:function(){i.appendTo(a)},success:function(t){return t.html?(e.render(e.container,t.html),n.twbsPagination({totalPages:t.total,onPageClick:o}),void i.detach()):(i.detach(),!1)}})},App.module["abstract"]=function(e){var t=$('<div class="overlay"><i class="fa fa-refresh fa-spin"></i></div>');e=$.extend({feature:"",container:"",render:function(e,t){$("<div/>").attr({id:this.feature,"class":"list-group no-margin"}).html(t).find('[data-toggle="tooltip"]').tooltip().end().replaceAll($(e))}},e),$.ajax({url:"/api/"+e.feature+"/",data:{type:"abstract"},beforeSend:function(){$(e.container).closest(".box").append(t)},success:function(a){e.render(e.container,a.html),t.remove()}})},App.module.list=function(e){e=$.extend(!0,{feature:"",filter:{type:"list",page:1},container:"",render:function(e,t){$(e).html(t)},visiblePages:7},e),$.extend($.fn.twbsPagination.defaults,{visiblePages:e.visiblePages});var t="/api/"+e.feature+"/",a=function(t){return"number"!=typeof t?e.filter:$.extend({},e.filter,{page:t})};this.paginate({api:t,filter:a,container:e.container,render:e.render})},App.module.detail=function(e){e=$.extend(!0,{path:"",feature:"",container:"",render:function(e,t){$(e).html(t)}},e),$.extend($.fn.twbsPagination.defaults,{visiblePages:7});var t="/api"+e.path+e.feature+"/",a=function(e){return"number"!=typeof e?{page:1}:{page:e}};this.paginate({api:t,filter:a,container:e.container,render:e.render})},App.module.collect=function(e,t){$(".collection").click(function(){function a(a){$.ajax({type:a,url:"/api/collection/",data:{type:"news"===e?"article":"topic",id:t},success:function(e){e.status&&(n.toggleClass("fa-star-o"),n.toggleClass("fa-star"),i.text("PUT"===a?"取消收藏":"添加收藏"))}})}var n=$(this).find("i"),i=$(this).find("span");a(n.hasClass("fa-star")?"DELETE":"PUT")})},App.module.dataTable=function(e){$.fn.dataTable.ext.errMode="throw",$(".initDataTable").each(function(){var t=$(this).DataTable({ajax:{url:"/api"+e,dataSrc:this.id,cache:!0},autoWidth:!1,pageLength:25,order:[],language:{processing:"处理中...",search:"",searchPlaceholder:"输入关键字过滤...",lengthMenu:"显示 _MENU_ 条",info:"显示第 _START_ 至 _END_ 条，共 _TOTAL_ 条",infoEmpty:"信息空",infoFiltered:"(由 _MAX_ 项结果过滤)",infoPostFix:"",loadingRecords:"载入中...",zeroRecords:"无匹配结果",emptyTable:"无结果",paginate:{first:"第一页",previous:"上一页",next:"下一页",last:"最后一页"},aria:{sortAscending:"正序排列",sortDescending:"倒序排列"}},deferLoading:100,drawCallback:function(){$('[data-toggle="tooltip"]').tooltip()}});t.on("click","tbody > tr",function(){$(this).hasClass("selected")?$(this).removeClass("selected"):(t.$("tr.selected").removeClass("selected"),$(this).addClass("selected"))})})},App.module.dateRange=function(e){e.on("show.dateRange",function(e,t,a){$(this).children("span").html(t+" ~ "+a)}).daterangepicker({ranges:{"过去7天":[moment().subtract(6,"days"),moment()],"过去30天":[moment().subtract(29,"days"),moment()],"这个月":[moment().startOf("month"),moment().endOf("month")],"上个月":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")]},locale:{format:"YYYY-MM-DD",separator:" - ",applyLabel:"确定",cancelLabel:"取消",fromLabel:"从",toLabel:"到",customRangeLabel:"自定义"},startDate:moment().subtract(6,"days"),endDate:moment(),minDate:"2010-01-01",maxDate:moment(),opens:"left",parentEl:".content-header",applyClass:"btn-success",cancelClass:"btn-default"})},App.module.statistic=function(e,t){var a=e.find(".statistic-total > span"),n=e.find(".statistic-risk > span");e.on("show.statistic",function(e,i,o){$.getJSON(t,{type:"statistic",start:i,end:o},function(e){a.text(e.total),n.text(e.risk)})})};
"use strict";App.page.login=function(e){e.login()},App.page.settings=function(e){e.settings()},App.page.user=function(e){e.admin(),e.register()},App.page.dashboard=function(e,t){$(".info-box-content").each(function(e,t){var a=$(t).find(".info-box-number"),i=$(t).find(".progress-bar"),n=$(t).find(".progress-description"),o=2e3,r=100,s=Math.floor(o/r),l=0,c=0,p=$(t).data("number"),d=p/s,u=0,w=$(t).data("percent"),f=w/s,h=function(e,t){a.text(e),i.width(t+"%"),n.text("占总数据 "+t+"%")},g=function(){s>l?(c+=d,u+=f,h(c.toFixed(),u.toFixed()),l++,setTimeout(g,r)):(c=p,u=w,h(c,u))};setTimeout(g,r)}),e["abstract"]({feature:"risk",container:"#risk > tbody",render:function(e,t){$("<tbody/>").html(t).showRisk().replaceAll($(e))}}),e.inspection(),e["abstract"]({feature:"news",container:"#news"}),e["abstract"]({feature:"event",container:"#event"}),e["abstract"]({feature:"weixin",container:"#weixin",render:function(e,t){$(e).html(t)}}),e["abstract"]({feature:"weibo",container:"#weibo",render:function(e,t){$(e).html(t)}}),e.line(t),e.pie(t)},App.page.news=function(e){e.list({feature:"news",container:"#news > tbody"})},App.page.newsDetail=function(e,t,a,i){e.collect(a,i)},App.page.event=function(e){e.list({feature:"event",container:"#event > tbody"})},App.page.eventDetail=function(e,t,a,i){e.collect(a,i),e.line(t,a),e.pie(t,a),e.detail({path:t,feature:"news",container:"#news > tbody"}),e.detail({path:t,feature:"weixin",container:"#weixin"}),e.detail({path:t,feature:"weibo",container:"#weibo"})},App.page.weixin=function(e){e.list({feature:"weixin",filter:{sort:"new"},container:"#weixin-new",visiblePages:3}),e.list({feature:"weixin",filter:{sort:"hot"},container:"#weixin-hot",visiblePages:3})},App.page.weixinDetail=function(){},App.page.weibo=function(e){e.list({feature:"weibo",filter:{sort:"new"},container:"#weibo-new",visiblePages:3}),e.list({feature:"weibo",filter:{sort:"hot"},container:"#weibo-hot",visiblePages:3})},App.page.categoryDetail=function(e,t){e.detail({path:t,feature:"news",container:"#news > tbody"})},App.page.locationDetail=function(e,t){e.detail({path:t,feature:"news",container:"#news > tbody"}),e.detail({path:t,feature:"weixin",container:"#weixin"}),e.detail({path:t,feature:"weibo",container:"#weibo"})},App.page.inspection=function(e,t){e.dataTable(t)},App.page.custom=function(){var e=document.forms.addKeyword,t=e.action,a=e.elements,i=a[0],n=a[1],o=a[2],r=$(e).prev(),s=$(e).parent().prev().find("li"),l=function(){o.disabled=!n.value},c=function(a){a.preventDefault(),$.post(t,$(e).serialize(),function(e){e.status?(r.text("关键词添加成功！").show(),location.reload()):(r.text("关键词添加失败！").show(),n.value="")})};s.length>=5?i.disabled=!0:$(e).keyup(l).submit(c)},App.page.customDetail=function(e,t){e.detail({path:t,feature:"news",container:"#news > tbody"}),e.detail({path:t,feature:"weixin",container:"#weixin"}),e.detail({path:t,feature:"weibo",container:"#weibo"})},App.page.collection=function(e,t){e.detail({path:t,feature:"news",container:"#news > tbody"}),e.detail({path:t,feature:"event",container:"#event > tbody"})},App.page.risk=function(e){e.list({feature:"risk",container:"#risk > tbody",render:function(e,t){$("<tbody/>").html(t).showRisk().replaceAll($(e))}})},App.page.riskDetail=function(e,t,a,i){e.collect(a,i),e.line(t,a),e.pie(t,a),e.detail({path:t,feature:"news",container:"#news > tbody"}),e.detail({path:t,feature:"weixin",container:"#weixin"}),e.detail({path:t,feature:"weibo",container:"#weibo"})},App.page.analyticsDetail=function(e,t){var a="/api"+t,i=$(".date-range-picker"),n=$("#chart"),o=$("#statistic"),r=moment().subtract(6,"days").format(),s=moment().format();e.dateRange(i),i.trigger("show.dateRange",[r,s]),n.on("show.chart",function(e,t,i){var n={},o=$(this).find(".tab-pane.active")[0].id.slice(6),r=function(e){var n={show:!0,title:"保存为Excel",icon:"image://../../static/img/excel.png",onclick:function(){document.getElementById("save-as-excel").src=a+"?type="+e+"&start="+t+"&end="+i+"&datatype=xls"}};return n};n.trend=function(e,t){$.getJSON(a,{type:"chart-trend",start:e,end:t},function(e){echarts.init(document.getElementById("chart-trend"),"macarons").setOption({tooltip:{backgroundColor:"rgba(50,50,50,0.5)",trigger:"axis",axisPointer:{type:"line",lineStyle:{color:"#008acd"}}},shadowStyle:{color:"rgba(200,200,200,0.2)"},legend:{data:["全部","新闻","微博","微信"]},grid:{x:50,y:30,x2:25,y2:65},toolbox:{show:!0,feature:{myTool:r("chart-trend"),saveAsImage:{show:!0}}},calculable:!0,xAxis:[{type:"category",boundaryGap:!1,data:e.date}],yAxis:[{type:"value"}],series:[{name:"全部",type:"line",data:e.total},{name:"新闻",type:"line",data:e.news},{name:"微博",type:"line",data:e.weibo},{name:"微信",type:"line",data:e.weixin}]})})},n.type=function(e,t){$.getJSON(a,{type:"chart-type",start:e,end:t},function(e){echarts.init(document.getElementById("chart-type"),"macarons").setOption({tooltip:{backgroundColor:"rgba(50,50,50,0.5)",trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:"vertical",x:"left",y:"bottom",data:["新闻","微博","微信"]},toolbox:{show:!0,feature:{myTool:r("chart-type"),saveAsImage:{show:!0}}},calculable:!0,series:[{name:"访问来源",type:"pie",radius:"55%",center:["50%","60%"],data:[{value:e.news,name:"新闻"},{value:e.weibo,name:"微博"},{value:e.weixin,name:"微信"}]}]})})},n.emotion=function(e,t){$.getJSON(a,{type:"chart-emotion",start:e,end:t},function(e){echarts.init(document.getElementById("chart-emotion"),"macarons").setOption({tooltip:{backgroundColor:"rgba(50,50,50,0.5)",trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:"vertical",x:"left",y:"bottom",data:["正面","中性","负面"]},toolbox:{show:!0,feature:{mark:{show:!1},myTool:r("chart-emotion"),magicType:{show:!1,type:["pie"],option:{funnel:{x:"25%",width:"50%",funnelAlign:"left",max:2e3}}},restore:{show:!1},saveAsImage:{show:!0}}},calculable:!0,series:[{name:"访问来源",type:"pie",radius:"55%",center:["50%","60%"],data:[{value:e.positive,name:"正面"},{value:e.normal,name:"中性"},{value:e.negative,name:"负面"}]}]})})},n.weibo=function(e,t){$.getJSON(a,{type:"chart-weibo",start:e,end:t},function(e){echarts.init(document.getElementById("chart-weibo-map"),"macarons").setOption({tooltip:{trigger:"item"},legend:{show:!1,orient:"vertical",x:"left",data:["微博文"]},dataRange:{min:0,max:e.value[9],x:"left",y:"bottom",text:["高","低"],calculable:!0},toolbox:{show:!0,orient:"horizontal",x:"left",y:"top",feature:{myTool:r("chart-weibo"),saveAsImage:{show:!0}}},roamController:{show:!0,x:"85%",mapTypeControl:{china:!0}},series:[{name:"微博文",type:"map",mapType:"china",roam:!1,itemStyle:{normal:{label:{show:!0}},emphasis:{label:{show:!0}}},data:e.province}]}),echarts.init(document.getElementById("chart-weibo-bar"),"macarons").setOption({title:{text:"微博地域分析",x:45},tooltip:{show:!1,trigger:"axis",axisPointer:{type:"shadow"}},legend:{show:!1,data:["微博文"]},toolbox:{show:!1,feature:{mark:{show:!0},magicType:{show:!0,type:["line","bar","stack","tiled"]},restore:{show:!0},saveAsImage:{show:!0}}},calculable:!1,grid:{borderWidth:0},xAxis:[{show:!1,type:"value"}],yAxis:[{show:!0,axisLine:!1,axisTick:!1,type:"category",splitLine:!1,splitArea:{show:!1},axisLabel:{show:!0,textStyle:{fontSize:14,fontWeight:"bolder"}},data:e.name}],series:[{name:"微博文",type:"bar",stack:"总量",barWidth:20,itemStyle:{normal:{label:{show:!0,textStyle:{color:"#000000",fontSize:14,fontWeight:"bolder"},position:"right"},color:"#3C8DBC"}},data:e.value}]})})},n[o](t,i)}),n.trigger("show.chart",[r,s]),e.statistic(o,a),o.trigger("show.statistic",[r,s]),n.on("shown.bs.tab",function(){n.trigger("show.chart",[r,s])}),i.on("apply.daterangepicker",function(e,t){r=t.startDate.format(),s=t.endDate.format(),i.trigger("show.dateRange",[r,s]),n.trigger("show.chart",[r,s]),o.trigger("show.statistic",[r,s])})};
"use strict";App.route=function(){var e,t,a=this.module,s=this.page,c=location.pathname,i=/^\/(\w+)\/$/,n=/^\/(\w+)\/(\d+)\/$/,o=null;switch(!0){case"/"===c:e="dashboard";break;case i.test(c):o=i.exec(c),e=o[1];break;case n.test(c):o=n.exec(c),e=o[1],t=+o[2]}return"login"===e?s.login(a):(a.search(),a.menu(c,e),void 0===t?s[e](a,c,e):s[e+"Detail"](a,c,e,t))},$(function(){App.route()});