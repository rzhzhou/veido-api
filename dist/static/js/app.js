"use strict";!function(){if("function"!=typeof $.fn.twbsPagination)throw new Error("twbsPagination required");var t={first:"第一页",prev:"上一页",next:"下一页",last:"最后一页",paginationClass:"pagination pagination-sm no-margin pull-right"};$.extend($.fn.twbsPagination.defaults,t)}();var App={module:{},page:{},route:function(){var t,e,a=this.module,n=this.page,i=location.pathname,o=/^\/(\w+)\/$/,s=/^\/(\w+)\/(\d+)\/$/,l=null;switch(!0){case"/"===i:t="dashboard";break;case o.test(i):l=o.exec(i),t=l[1];break;case s.test(i):l=s.exec(i),t=l[1],e=+l[2]}return"login"===t?n.login(a):(a.search(),a.menu(i,t),void 0===e?n[t](a,i,t):n[t+"Detail"](a,i,t,e))}};App.module.login=function(){var t=document.forms.login,e=t.action,a=t.elements,n=a.username,i=a.password,o=a[2],s=$(t).find("p"),l=function(){o.disabled=!(n.value&&i.value)},r=function(a){a.preventDefault(),$.post(e,$(t).serialize(),function(t){t.status?location.href=location.search?location.search.substr(1).split("=")[1]:"/":(s.text("用户名或密码错误！"),o.disabled=!0,i.value="")})};$(t).keyup(l).submit(r)},App.module.register=function(){var t=document.forms.add,e=t.action,a=t.elements,n=a.username,i=a.password,o=a.retype,s=a[3],l=$(t).find("p"),r=function(){s.disabled=!(n.value&&i.value&&o.value)},c=function(t){t.preventDefault();var a=function(t){t.status?location.reload():l.text("抱歉，添加失败！").show()};i.value===o.value?$.post(e,$([n,i]).serialize(),a):(l.text("两次输入密码不一致！").show(),s.disabled=!0,i.value="",o.value="")};$(t).keyup(r).submit(c)},App.module.admin=function(){var t=$(".user-admin"),e=t.find("input"),a=t.find("button"),n=a.eq(0),i=a.eq(1),o=[],s=function(t,a){t.click(function(){o.length=0,e.filter(":checked").each(function(t,e){o.push($(e).parent().next().data("id"))}),o.length&&$.post(a,{id:o.toString()},function(t){t.status&&location.reload()})})};s(n,"/api/user/reset/"),s(i,"/api/user/remove/")},App.module.settings=function(){var t=document.forms.info,e=t.action,a=t.elements,n=a.username,i=a.oldPassword,o=a.newPassword,s=a.retype,l=a[4],r=$(t).find("p"),c=function(){l.disabled=!(n.value&&i.value&&o.value&&s.value)},u=function(t){t.preventDefault();var a=function(t){t.status?(r.text("更新成功！").show(),location.href="/login/"):(r.text("原密码错误！").show(),i.value="",o.value="",s.value="")};o.value===s.value?$.post(e,$([n,i,o]).serialize(),a):(r.text("两次输入密码不一致！").show(),o.value="",s.value="")};$(t).keyup(c).submit(u)},App.module.line=function(t){$.getJSON("/api/line"+t,function(t){echarts.init($("#line-chart")[0],"macarons").setOption({color:["#00a65a","#00c0ef","#dd4b39"],tooltip:{trigger:"axis"},legend:{data:["正面","中性","负面"]},grid:{x:40,y:30,x2:25,y2:30},xAxis:[{type:"category",boundaryGap:!1,data:t.date}],yAxis:[{type:"value"}],series:[{name:"正面",type:"line",data:t.positive},{name:"中性",type:"line",data:t.neutral},{name:"负面",type:"line",data:t.negative}]})})},App.module.pie=function(t){$.getJSON("/api/pie"+t,function(t){echarts.init($("#pie-chart")[0],"macarons").setOption({tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{data:t.name},series:[{name:"信息比例",type:"pie",radius:"55%",center:["50%","60%"],data:t.value}]})})},App.module.search=function(){var t=document.forms.search,e=t.elements.keywords;$(t).submit(function(a){a.preventDefault();var n=$.trim(e.value);n&&(t.reset(),location.href="/search/"+n+"/")})},App.module.menu=function(t,e){var a=$(".sidebar-menu"),n=a.parent(),i=function(){var a=this.getAttribute("href");switch(!0){case"dashboard"===e:return"/"===a;case"category"===e:case"location"===e:return a===t;default:return a.split("/")[1]===e}};a.detach().find("a").filter(i).parent().addClass("active").closest(".treeview-menu").addClass("menu-open").closest(".treeview").addClass("active"),a.appendTo(n)},App.module.infoBox=function(){var t=function(t,e){var a,n=$(e).find(".info-box-number"),i=$(e).find(".progress-bar"),o=$(e).find(".progress-description"),s=2e3,l=100,r=Math.floor(s/l),c=0,u=0,p=$(e).data("number"),d=Math.floor(p/r),f=0,g=$(e).data("percent"),m=Math.floor(g/r),v=function(){u+=d,f+=m,c++,c>=r&&(clearInterval(a),u=p,f=g),n.text(u.toFixed()),i.width(f+"%"),o.text("占总数据 "+f.toFixed()+"%")};a=setInterval(v,l)};$(".info-box-content").each(t)},App.module.inspection=function(){var t=$("#inspection"),e=t.children(".box-body").find("tbody");e.load("/api/dashboard/local-inspection/"),t.on("click","button",function(t){return t.preventDefault(),$(this).hasClass("active")?!1:($(this).addClass("active").siblings().removeClass("active"),void e.load("/api/dashboard/"+this.id+"/"))})},App.module.returnTop=function(t){var e=t.offset().top,a=e>160?e-120:0;$("body").animate({scrollTop:a})},App.module.table=function(t,e){$(".table-custom").each(function(){var a=$(this),n=a.parent(),i=this.tBodies[0],o=this.id,s=function(t){var e=t.data,a=$.map(e,function(t){var e="/"+o+"/"+t.id+"/",a='<td><a href="'+e+'" title="'+t.title+'" target="_blank">'+t.title+"</a></td>",n="<td>"+t.source+"</td>",i="<td>"+t.location+"</td>",s="<td>"+t.time+"</td>",l='<td class="text-center">'+t.hot+"</td>",r="<tr>"+a+n+i+s+l+"</tr>";return r});$(i).html(a)};$.getJSON("/api"+e+o+"/1/",function(i){s(i),n.twbsPagination({totalPages:i.total,visiblePages:7,onPageClick:function(i,l){t.returnTop(a),$.getJSON("/api"+e+o+"/"+l+"/",function(t){s(t),n.twbsPagination({totalPages:t.total})})}})})})},App.module.collect=function(t,e){$(".collection").click(function(){var a=$(this).find("i"),n=$(this).find("span"),i=function(i,o){var s={type:"news"===t?"article":"topic",id:e};$.post(i,s,function(t){t.status&&(a.toggleClass("fa-star-o"),a.toggleClass("fa-star"),n.text(o))})};a.hasClass("fa-star")?i("/api/collection/remove/","添加收藏"):i("/api/collection/add/","取消收藏")})},App.module.sns=function(t,e,a){var n=$(".sns");n.each(function(i,o){var s=$(o),l=s.parent().next(),r=function(){return"weixin"===a||"weibo"===a?l.data("type"):l.data("type").replace("-","/")};$.getJSON("/api"+e+r()+"/1/",function(a){s.html(a.html),l.twbsPagination({totalPages:a.total,onPageClick:function(a,i){t.returnTop(n),$.getJSON("/api"+e+r()+"/"+i+"/",function(t){s.html(t.html),l.twbsPagination({totalPages:t.total})})}})})})},App.module.dataTable=function(t){$.fn.dataTable.ext.errMode="throw",$(".initDataTable").each(function(){var e=$(this).DataTable({ajax:{url:"/api"+t,dataSrc:this.id,cache:!0},autoWidth:!1,pageLength:25,order:[],language:{processing:"处理中...",search:"",searchPlaceholder:"输入关键字过滤...",lengthMenu:"显示 _MENU_ 条",info:"显示第 _START_ 至 _END_ 条，共 _TOTAL_ 条",infoEmpty:"信息空",infoFiltered:"(由 _MAX_ 项结果过滤)",infoPostFix:"",loadingRecords:"载入中...",zeroRecords:"无匹配结果",emptyTable:"无结果",paginate:{first:"第一页",previous:"上一页",next:"下一页",last:"最后一页"},aria:{sortAscending:"正序排列",sortDescending:"倒序排列"}},deferLoading:100,drawCallback:function(){$('[data-toggle="tooltip"]').tooltip()}});e.on("click","tbody > tr",function(){$(this).hasClass("selected")?$(this).removeClass("selected"):(e.$("tr.selected").removeClass("selected"),$(this).addClass("selected"))})})},App.module.custom=function(){var t=document.forms.addKeyword,e=t.action,a=t.elements,n=a[0],i=a[1],o=a[2],s=$(t).prev(),l=$(t).parent().prev().find("li"),r=function(){o.disabled=!i.value},c=function(a){a.preventDefault(),$.post(e,$(t).serialize(),function(t){t.status?(s.text("关键词添加成功！").show(),location.reload()):(s.text("关键词添加失败！").show(),i.value="")})};l.length>=5?n.disabled=!0:$(t).keyup(r).submit(c)},App.page.login=function(t){t.login()},App.page.settings=function(t){t.settings()},App.page.user=function(t){t.admin(),t.register()},App.page.dashboard=function(t,e){t.infoBox(),t.line(e),t.pie(e),t.inspection()},App.page.news=function(t,e){t.table(t,e)},App.page.newsDetail=function(t,e,a,n){t.collect(a,n)},App.page.event=function(t,e){t.table(t,e)},App.page.eventDetail=function(t,e,a,n){t.collect(a,n),t.line(e,a),t.pie(e,a),t.table(t,e),t.sns(t,e,a)},App.page.weixin=function(t,e,a){t.sns(t,e,a)},App.page.weixinDetail=function(){},App.page.weibo=function(t,e,a){t.sns(t,e,a)},App.page.categoryDetail=function(t,e){t.table(t,e)},App.page.locationDetail=function(t,e,a){t.table(t,e),t.sns(t,e,a)},App.page.inspection=function(t,e){t.dataTable(e)},App.page.custom=function(t){t.custom()},App.page.customDetail=function(t,e,a){t.table(t,e),t.sns(t,e,a)},App.page.collection=function(t,e){t.table(t,e)},$(function(){App.route()});